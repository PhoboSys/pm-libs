{"version":3,"file":"storage.js","names":["_lodash","require","_logger","_interopRequireDefault","_keyChain","e","__esModule","_typeof","o","Symbol","iterator","constructor","prototype","_classCallCheck","a","n","TypeError","_defineProperties","r","t","length","enumerable","configurable","writable","Object","defineProperty","_toPropertyKey","key","_createClass","i","_toPrimitive","toPrimitive","call","String","Number","STORAGE_LOCAL","exports","STORAGE_COOKIE","Storage","config","keyChain","KeyChain","value","get","storageKey","_getStorageKey","state","_getStorageState","JSON","parse","logger","info","_setStorageState","stringify","set","path","newState","clearStorageExceptCurrentKey","allKeys","_getAllKeys","allAppKeys","getAllAppKeys","idx","_removeStorageState","storageCleanUp","invalidKeys","findInvalidKeys","findValidKey","push"],"sources":["../../libs/persistence-js/storage.js"],"sourcesContent":["import { set } from 'lodash'\n\nimport logger from '../logger'\n\nimport KeyChain from './key-chain'\n\nexport const STORAGE_LOCAL = 'local'\nexport const STORAGE_COOKIE = 'cookie'\n\nexport default class Storage {\n\n  constructor (config) {\n    this.default = {}\n    this.keyChain = new KeyChain(config)\n  }\n\n  get() {\n    const storageKey = this._getStorageKey()\n    try {\n\n      const state = this._getStorageState(storageKey)\n      return state === null\n        ? this.default\n        : JSON.parse(state)\n\n    } catch (e) {\n      logger.info('Persistence detect corrupted state, resetting to default', e)\n\n      this._setStorageState(storageKey, JSON.stringify(this.default))\n\n      return this.default\n    }\n  }\n\n  set(path, value) {\n    const storageKey = this._getStorageKey()\n    const state = this.get()\n\n    try {\n      let newState = value || this.default\n      if (path) newState = set(state, path, value)\n      this._setStorageState(storageKey, JSON.stringify(newState))\n    } catch (e) {\n      logger.info('Storage state could not be saved!', e)\n\n      //clean up all keys except current storage key\n      this.clearStorageExceptCurrentKey(storageKey)\n    }\n  }\n\n  clearStorageExceptCurrentKey(key) {\n    const allKeys = this._getAllKeys()\n    const allAppKeys = this.keyChain.getAllAppKeys(allKeys)\n\n    for (const idx in allAppKeys) {\n      if (key !== allAppKeys[idx]) {\n        this._removeStorageState(allAppKeys[idx])\n      }\n    }\n  }\n\n  storageCleanUp() {\n    const allKeys = this._getAllKeys()\n    const invalidKeys = this.keyChain.findInvalidKeys(allKeys)\n\n    for (const idx in invalidKeys) {\n      this._removeStorageState(invalidKeys[idx])\n    }\n  }\n\n  _getStorageKey() {\n    const allKeys = this._getAllKeys()\n    const storageKey = this.keyChain.findValidKey(allKeys)\n\n    return storageKey\n  }\n\n  _getAllKeys() {\n    const allKeys = []\n    for (const key in this._getStorageState()) {\n      allKeys.push(key)\n    }\n    return allKeys\n  }\n}\n"],"mappings":";;;;;;AAAA,IAAAA,OAAA,GAAAC,OAAA;AAEA,IAAAC,OAAA,GAAAC,sBAAA,CAAAF,OAAA;AAEA,IAAAG,SAAA,GAAAD,sBAAA,CAAAF,OAAA;AAAkC,SAAAE,uBAAAE,CAAA,WAAAA,CAAA,IAAAA,CAAA,CAAAC,UAAA,GAAAD,CAAA,gBAAAA,CAAA;AAAA,SAAAE,QAAAC,CAAA,sCAAAD,OAAA,wBAAAE,MAAA,uBAAAA,MAAA,CAAAC,QAAA,aAAAF,CAAA,kBAAAA,CAAA,gBAAAA,CAAA,WAAAA,CAAA,yBAAAC,MAAA,IAAAD,CAAA,CAAAG,WAAA,KAAAF,MAAA,IAAAD,CAAA,KAAAC,MAAA,CAAAG,SAAA,qBAAAJ,CAAA,KAAAD,OAAA,CAAAC,CAAA;AAAA,SAAAK,gBAAAC,CAAA,EAAAC,CAAA,UAAAD,CAAA,YAAAC,CAAA,aAAAC,SAAA;AAAA,SAAAC,kBAAAZ,CAAA,EAAAa,CAAA,aAAAC,CAAA,MAAAA,CAAA,GAAAD,CAAA,CAAAE,MAAA,EAAAD,CAAA,UAAAX,CAAA,GAAAU,CAAA,CAAAC,CAAA,GAAAX,CAAA,CAAAa,UAAA,GAAAb,CAAA,CAAAa,UAAA,QAAAb,CAAA,CAAAc,YAAA,kBAAAd,CAAA,KAAAA,CAAA,CAAAe,QAAA,QAAAC,MAAA,CAAAC,cAAA,CAAApB,CAAA,EAAAqB,cAAA,CAAAlB,CAAA,CAAAmB,GAAA,GAAAnB,CAAA;AAAA,SAAAoB,aAAAvB,CAAA,EAAAa,CAAA,EAAAC,CAAA,WAAAD,CAAA,IAAAD,iBAAA,CAAAZ,CAAA,CAAAO,SAAA,EAAAM,CAAA,GAAAC,CAAA,IAAAF,iBAAA,CAAAZ,CAAA,EAAAc,CAAA,GAAAK,MAAA,CAAAC,cAAA,CAAApB,CAAA,iBAAAkB,QAAA,SAAAlB,CAAA;AAAA,SAAAqB,eAAAP,CAAA,QAAAU,CAAA,GAAAC,YAAA,CAAAX,CAAA,gCAAAZ,OAAA,CAAAsB,CAAA,IAAAA,CAAA,GAAAA,CAAA;AAAA,SAAAC,aAAAX,CAAA,EAAAD,CAAA,oBAAAX,OAAA,CAAAY,CAAA,MAAAA,CAAA,SAAAA,CAAA,MAAAd,CAAA,GAAAc,CAAA,CAAAV,MAAA,CAAAsB,WAAA,kBAAA1B,CAAA,QAAAwB,CAAA,GAAAxB,CAAA,CAAA2B,IAAA,CAAAb,CAAA,EAAAD,CAAA,gCAAAX,OAAA,CAAAsB,CAAA,UAAAA,CAAA,YAAAb,SAAA,yEAAAE,CAAA,GAAAe,MAAA,GAAAC,MAAA,EAAAf,CAAA;AAE3B,IAAMgB,aAAa,GAAAC,OAAA,CAAAD,aAAA,GAAG,OAAO;AAC7B,IAAME,cAAc,GAAAD,OAAA,CAAAC,cAAA,GAAG,QAAQ;AAAA,IAEjBC,OAAO,GAAAF,OAAA;EAE1B,SAAAE,QAAaC,MAAM,EAAE;IAAA1B,eAAA,OAAAyB,OAAA;IACnB,IAAI,WAAQ,GAAG,CAAC,CAAC;IACjB,IAAI,CAACE,QAAQ,GAAG,IAAIC,oBAAQ,CAACF,MAAM,CAAC;EACtC;EAAC,OAAAX,YAAA,CAAAU,OAAA;IAAAX,GAAA;IAAAe,KAAA,EAED,SAAAC,GAAGA,CAAA,EAAG;MACJ,IAAMC,UAAU,GAAG,IAAI,CAACC,cAAc,CAAC,CAAC;MACxC,IAAI;QAEF,IAAMC,KAAK,GAAG,IAAI,CAACC,gBAAgB,CAACH,UAAU,CAAC;QAC/C,OAAOE,KAAK,KAAK,IAAI,GACjB,IAAI,WAAQ,GACZE,IAAI,CAACC,KAAK,CAACH,KAAK,CAAC;MAEvB,CAAC,CAAC,OAAOzC,CAAC,EAAE;QACV6C,kBAAM,CAACC,IAAI,CAAC,0DAA0D,EAAE9C,CAAC,CAAC;QAE1E,IAAI,CAAC+C,gBAAgB,CAACR,UAAU,EAAEI,IAAI,CAACK,SAAS,CAAC,IAAI,WAAQ,CAAC,CAAC;QAE/D,OAAO,IAAI,WAAQ;MACrB;IACF;EAAC;IAAA1B,GAAA;IAAAe,KAAA,EAED,SAAAY,GAAGA,CAACC,IAAI,EAAEb,KAAK,EAAE;MACf,IAAME,UAAU,GAAG,IAAI,CAACC,cAAc,CAAC,CAAC;MACxC,IAAMC,KAAK,GAAG,IAAI,CAACH,GAAG,CAAC,CAAC;MAExB,IAAI;QACF,IAAIa,QAAQ,GAAGd,KAAK,IAAI,IAAI,WAAQ;QACpC,IAAIa,IAAI,EAAEC,QAAQ,GAAG,IAAAF,WAAG,EAACR,KAAK,EAAES,IAAI,EAAEb,KAAK,CAAC;QAC5C,IAAI,CAACU,gBAAgB,CAACR,UAAU,EAAEI,IAAI,CAACK,SAAS,CAACG,QAAQ,CAAC,CAAC;MAC7D,CAAC,CAAC,OAAOnD,CAAC,EAAE;QACV6C,kBAAM,CAACC,IAAI,CAAC,mCAAmC,EAAE9C,CAAC,CAAC;;QAEnD;QACA,IAAI,CAACoD,4BAA4B,CAACb,UAAU,CAAC;MAC/C;IACF;EAAC;IAAAjB,GAAA;IAAAe,KAAA,EAED,SAAAe,4BAA4BA,CAAC9B,GAAG,EAAE;MAChC,IAAM+B,OAAO,GAAG,IAAI,CAACC,WAAW,CAAC,CAAC;MAClC,IAAMC,UAAU,GAAG,IAAI,CAACpB,QAAQ,CAACqB,aAAa,CAACH,OAAO,CAAC;MAEvD,KAAK,IAAMI,GAAG,IAAIF,UAAU,EAAE;QAC5B,IAAIjC,GAAG,KAAKiC,UAAU,CAACE,GAAG,CAAC,EAAE;UAC3B,IAAI,CAACC,mBAAmB,CAACH,UAAU,CAACE,GAAG,CAAC,CAAC;QAC3C;MACF;IACF;EAAC;IAAAnC,GAAA;IAAAe,KAAA,EAED,SAAAsB,cAAcA,CAAA,EAAG;MACf,IAAMN,OAAO,GAAG,IAAI,CAACC,WAAW,CAAC,CAAC;MAClC,IAAMM,WAAW,GAAG,IAAI,CAACzB,QAAQ,CAAC0B,eAAe,CAACR,OAAO,CAAC;MAE1D,KAAK,IAAMI,GAAG,IAAIG,WAAW,EAAE;QAC7B,IAAI,CAACF,mBAAmB,CAACE,WAAW,CAACH,GAAG,CAAC,CAAC;MAC5C;IACF;EAAC;IAAAnC,GAAA;IAAAe,KAAA,EAED,SAAAG,cAAcA,CAAA,EAAG;MACf,IAAMa,OAAO,GAAG,IAAI,CAACC,WAAW,CAAC,CAAC;MAClC,IAAMf,UAAU,GAAG,IAAI,CAACJ,QAAQ,CAAC2B,YAAY,CAACT,OAAO,CAAC;MAEtD,OAAOd,UAAU;IACnB;EAAC;IAAAjB,GAAA;IAAAe,KAAA,EAED,SAAAiB,WAAWA,CAAA,EAAG;MACZ,IAAMD,OAAO,GAAG,EAAE;MAClB,KAAK,IAAM/B,GAAG,IAAI,IAAI,CAACoB,gBAAgB,CAAC,CAAC,EAAE;QACzCW,OAAO,CAACU,IAAI,CAACzC,GAAG,CAAC;MACnB;MACA,OAAO+B,OAAO;IAChB;EAAC;AAAA","ignoreList":[]}