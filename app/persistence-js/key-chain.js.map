{"version":3,"file":"key-chain.js","names":["_lodash","require","_typeof","o","Symbol","iterator","constructor","prototype","_classCallCheck","a","n","TypeError","_defineProperties","e","r","t","length","enumerable","configurable","writable","Object","defineProperty","_toPropertyKey","key","_createClass","i","_toPrimitive","toPrimitive","call","String","Number","KeyChain","exports","config","storageId","appName","storageName","Error","resource","lifeTime","lifeTimeMs","value","findInvalidKeys","allKeys","_this","decoratedKeys","_buildDecoratedKeys","validKey","_findValidKey","invalidKeys","filter","isAppKey","_isKeyExpired","isInstanceKey","get","result","map","decoratedKey","findValidKey","_this2","validKeys","latestKey","_getLatestKey","generateKey","getAllAppKeys","appKeys","concat","Date","now","deckey","apprex","_getAppKeyRex","insrex","_getInstanceKeyRex","test","timestamp","exec","keys","reduce","latest","current","RegExp"],"sources":["../../libs/persistence-js/key-chain.js"],"sourcesContent":["import { get } from 'lodash'\n\nexport default class KeyChain {\n\n  constructor (config) {\n    if (!config.storageId || !config.appName || !config.storageName) {\n      throw new Error('Could not initialize persistence, missing config!')\n    }\n\n    this.appName = config.appName\n    this.storageId = config.storageId\n    this.storageName = config.storageName\n    this.resource = config.resource\n    this.lifeTime = config.lifeTime || 365 //days\n    this.lifeTimeMs = this.lifeTime * 24 * 60 * 60 * 1000\n  }\n\n  findInvalidKeys(allKeys) {\n    const decoratedKeys = this._buildDecoratedKeys(allKeys)\n    const validKey = this._findValidKey(decoratedKeys)\n\n    const invalidKeys = decoratedKeys.filter(key => (\n      key.isAppKey && this._isKeyExpired(key) ||\n      key.isInstanceKey && validKey !== get(key, 'key')\n    ))\n\n    const result = invalidKeys.map(decoratedKey => decoratedKey.key)\n    return result\n  }\n\n  findValidKey(allKeys) {\n    const decoratedKeys = this._buildDecoratedKeys(allKeys)\n    return this._findValidKey(decoratedKeys)\n  }\n\n  _findValidKey(decoratedKeys) {\n    const validKeys = decoratedKeys.filter(key =>\n      key.isInstanceKey && !this._isKeyExpired(key)\n    )\n\n    const latestKey = this._getLatestKey(validKeys)\n    const validKey = get(latestKey, 'key', this.generateKey())\n\n    return validKey\n  }\n\n  getAllAppKeys(allKeys) {\n    const decoratedKeys = this._buildDecoratedKeys(allKeys)\n    const appKeys = decoratedKeys.filter(key => key.isAppKey)\n\n    return appKeys.map(decoratedKey => decoratedKey.key)\n  }\n\n  generateKey() {\n    return `__${this.appName}__state__${this.storageName}__${this.storageId}__${Date.now() + this.lifeTimeMs}`\n  }\n\n  _isKeyExpired(deckey) {\n    return get(deckey, 'timestamp', 0) < Date.now()\n  }\n\n  _buildDecoratedKeys(allKeys){\n    allKeys = allKeys || []\n    const apprex = this._getAppKeyRex(allKeys)\n    const insrex = this._getInstanceKeyRex()\n    const decoratedKeys = allKeys.map(key => ({\n      key: key,\n      isAppKey: apprex.test(key),\n      isInstanceKey: insrex.test(key),\n      timestamp: +get(apprex.exec(key), 1, 0)\n    }))\n    return decoratedKeys\n  }\n\n  _getLatestKey(keys) {\n    return keys.reduce((latest, current) =>\n      get(latest, 'timestamp') > get(current, 'timestamp') ? latest : current\n    , get(keys, 0))\n  }\n\n  _getInstanceKeyRex() {\n    return new RegExp(`_${this.appName}__state__${this.storageName}__${this.storageId}__.*?_?_?([^_]*)$`)\n  }\n\n  _getAppKeyRex() {\n    return new RegExp(`_${this.appName}__state__.*?_?_?([^_]*)$`)\n  }\n}\n"],"mappings":"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","ignoreList":[]}