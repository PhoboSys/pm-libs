{"version":3,"file":"index.js","names":["_logger","_interopRequireDefault","require","_lodash","_convention","_dispatchType","_actionStatus","e","__esModule","_typeof","o","Symbol","iterator","constructor","prototype","ownKeys","r","t","Object","keys","getOwnPropertySymbols","filter","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","arguments","length","forEach","_defineProperty","getOwnPropertyDescriptors","defineProperties","defineProperty","_toPropertyKey","value","configurable","writable","i","_toPrimitive","toPrimitive","call","TypeError","String","Number","_inprogress","actionize","dispatchs","isFunction","keyBy","printError","msg","logger","info","console","error","serializer","key","cqrsMiddleware","asynchronous","store","next","action","dispatchType","metadata","type","concat","_actionstr","JSON","stringify","args","_action","parse","method","dispatch","rejected","status","THROTTLED","origin","QUERY","promise","then","result","success","SUCCEED","isError","toString","fails","FAILED","METADATA","initMetadata","isEmpty","isPlainObject","isNull","structuredClone","_creator","actionName","command","COMMAND","query","cqrsDispatchMapper","dispatchMapper","ownProps","actions","actionType","dispatches","connectDecorator","reduxConnect","stateMapper","merge","options","start","Date","now","connector","connecttook","warn","findAction","get"],"sources":["../../libs/redux-cqrs/index.js"],"sourcesContent":["import logger from '@lib/logger'\nimport {\n  isPlainObject,\n  isFunction,\n  isEmpty,\n  isError,\n  isNull,\n  filter,\n  keyBy,\n} from 'lodash'\n\nimport { success, rejected, fails } from './convention'\nimport { QUERY, COMMAND } from './dispatchType'\nimport { THROTTLED, SUCCEED, FAILED } from './actionStatus'\n\nlet _inprogress = {}\n\nfunction actionize(dispatchs) {\n  dispatchs = filter(dispatchs, isFunction)\n  dispatchs = filter(dispatchs, 'actionType')\n  return keyBy(dispatchs, 'actionType')\n}\n\nfunction printError(msg) {\n  logger.info(msg)\n  console.error(msg) // eslint-disable-line\n}\n\nfunction serializer(key, value) {\n  if (typeof value === 'bigint') value = String(value)\n  if (typeof value === 'undefined') value = String(null)\n  return value\n}\n\nexport function cqrsMiddleware(asynchronous) {\n  return store => next => action => {\n    const { dispatchType } = action.metadata\n    const type = action.type\n\n    if (!dispatchType) {\n      printError(`${type} get ignore`)\n      return next(action)\n    }\n\n    const _actionstr = JSON.stringify({ type, args: action.args }, serializer)\n    const _action = JSON.parse(_actionstr)\n    const method = asynchronous[type]\n\n    if (typeof method !== 'function') return next(action)\n\n    if (_actionstr in _inprogress) {\n      return store.dispatch({\n        ..._action,\n        type: rejected(type),\n        metadata: {\n          dispatchType,\n          status: THROTTLED,\n          origin: action,\n        }\n      })\n    }\n\n    if (dispatchType === QUERY) {\n      _inprogress[_actionstr] = null\n    }\n\n    const promise = method(action.args)\n    next(action)\n    return promise\n      .then(result => {\n        delete _inprogress[_actionstr]\n        _action.args.result = JSON.parse(JSON.stringify(result, serializer))\n        return store.dispatch({\n          ..._action,\n          type: success(type),\n          metadata: {\n            dispatchType,\n            status: SUCCEED,\n            origin: action,\n          }\n        })\n      })\n      .catch(error => {\n        delete _inprogress[_actionstr]\n        if (isError(error)) {\n          printError(error)\n          error = error.toString()\n        }\n        _action.args.error = error\n        return store.dispatch({\n          ..._action,\n          type: fails(type),\n          metadata: {\n            dispatchType,\n            status: FAILED,\n            origin: action,\n          }\n        })\n      })\n  }\n}\n\nlet METADATA = null\nexport function initMetadata(metadata) {\n  if (isEmpty(metadata) || !isPlainObject(metadata)) return\n  if (!isNull(METADATA)) return\n\n  METADATA = structuredClone(metadata)\n}\n\nfunction _creator(actionName, args, metadata, dispatchType) {\n  if (!isEmpty(args) && !isPlainObject(args)) args = {}\n  if (!isEmpty(metadata) && !isPlainObject(metadata)) metadata = {}\n\n  args = args || {}\n  metadata = metadata || {}\n\n  return {\n    type: actionName,\n    args,\n    metadata: {\n      ...METADATA,\n      ...metadata,\n      dispatchType\n    }\n  }\n}\n\nexport function command(actionName, args, metadata) {\n  return _creator(actionName, args, metadata, COMMAND)\n}\n\nexport function query(actionName, args, metadata) {\n  return _creator(actionName, args, metadata, QUERY)\n}\n\nexport function cqrsDispatchMapper(dispatchMapper) {\n  if (!isFunction(dispatchMapper)) return dispatchMapper\n\n  return (dispatch, ownProps) => {\n    const actions = dispatchMapper(\n      {\n        command: (actionName) => {\n          const result = (args) => dispatch(command(actionName, args))\n          result.actionType = actionName\n          return result\n        },\n        query: (actionName) => {\n          const result = (args) => dispatch(query(actionName, args))\n          result.actionType = actionName\n          return result\n        }\n      },\n      ownProps\n    )\n    const dispatches = actionize(actions)\n    dispatches['dispatch'] = dispatch\n    return dispatches\n  }\n}\n\nexport function connectDecorator(reduxConnect, stateMapper, dispatchMapper, merge, options) {\n  if (!isFunction(reduxConnect)) {\n    return printError('Missing reduxConnect function!')\n  }\n\n  const start = Date.now()\n  const connector = reduxConnect(stateMapper, cqrsDispatchMapper(dispatchMapper), merge, options)\n  const connecttook = Date.now() - start\n  if (connecttook > 10) {\n    logger.warn('[Violation] Connect took ' + connecttook + 'ms')\n  }\n  return connector\n}\n\nexport function findAction (action, type) {\n\n  while (action && action.type !== type) {\n    action = get(action, ['metadata', 'origin'])\n  }\n\n  return action\n}\n\nexport { success, rejected, fails, QUERY, COMMAND, THROTTLED, SUCCEED, FAILED }\n\n\n"],"mappings":"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","ignoreList":[]}